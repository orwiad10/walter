{% extends 'base.html' %}
{% block content %}
<h2>{{ t.name }}</h2>
<p>Format: {{ t.format }}{% if t.format == 'Draft' and t.is_cube %} (Cube){% endif %} | Cut: {{ t.cut|upper }}</p>
<p>Rules Enforcement Level: {{ t.rules_enforcement_level }}</p>
<p>Head Judge: {{ t.head_judge.name if t.head_judge else 'None' }}</p>
<p>Floor Judges:
  {% if floor_judges %}
    {% for u in floor_judges %}{{ u.name }}{% if not loop.last %}, {% endif %}{% endfor %}
  {% else %}None{% endif %}
</p>
{% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
<p><a class="btn" href="{{ url_for('assign_judges', tid=t.id) }}">Assign Judges</a></p>
{% endif %}
{% if show_passcode %}
<p>Tournament Passcode: {{ t.passcode }}</p>
{% endif %}
{% include 'tournament/_timer_bar.html' %}
{% set round_limit = t.rounds_override or rec_rounds %}
{% set current_rounds = rounds|length %}
<div class="toolbar">
  <button class="btn" onclick="window.print()">Print</button>
  {% if not is_player %}
  <form method="post" action="{{ url_for('join_tournament', tid=t.id) }}">
    {% if current_user.is_authenticated %}
      <input type="text" name="passcode" maxlength="4" pattern="\d{4}" placeholder="Passcode" required>
      <button class="btn" type="submit">Join</button>
    {% else %}
      <a class="btn" href="{{ url_for('login') }}">Login to Join</a>
    {% endif %}
  </form>
  {% endif %}
  <a class="btn" href="{{ url_for('standings', tid=t.id) }}">Standings</a>
  {% if t.cut.startswith('top') %}
  <a class="btn" href="{{ url_for('bracket', tid=t.id) }}">Bracket</a>
  {% endif %}
  {% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
    {% if current_rounds < round_limit or t.cut.startswith('top') %}
    <form method="post" action="{{ url_for('pair_next_round', tid=t.id) }}">
      <button class="btn" type="submit">Pair</button>
    </form>
    {% endif %}
    <form method="post" action="{{ url_for('set_rounds', tid=t.id) }}">
      <input type="number" name="rounds" min="1" value="{{ t.rounds_override or rec_rounds }}">
      <button class="btn" type="submit">Set Rounds</button>
    </form>
    {% if t.format == 'Draft' %}
    <a class="btn" href="{{ url_for('draft_seating', tid=t.id) }}">Draft Seating</a>
    {% endif %}
    <a class="btn" href="{{ url_for('tournament_logs', tid=t.id) }}">Logs</a>
  {% endif %}
</div>

{% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
<section class="inline-add-player">
  <h3>Add Player</h3>
  <form method="post" action="{{ url_for('add_player_to_tournament', tid=t.id) }}" class="message-form add-player-form">
    <label>Find Existing Player
      <input type="text" id="add-player-search" placeholder="Search by name or email" autocomplete="off">
    </label>
    <div id="add-player-results" class="user-lookup-results" aria-live="polite"></div>
    <input type="hidden" name="user_id" id="add-player-id">
    <p class="inline-form-divider">or quick add</p>
    <label>Player Name
      <input type="text" name="new_player_name" placeholder="New player name">
    </label>
    <label>Email (optional)
      <input type="email" name="new_player_email" placeholder="email@example.com">
    </label>
    <button class="btn" type="submit">Add Player</button>
  </form>
</section>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    if(window.attachUserLookup){
      window.attachUserLookup('add-player-search', 'add-player-results', 'add-player-id');
    }
  });
</script>
{% endif %}

<h3>Players ({{ players|length }})</h3>
<table class="players-table">
  <tbody>
  {% for p in players %}
    <tr><td>{{ p.user.name }}</td></tr>
  {% endfor %}
  </tbody>
</table>

<h3>Rounds</h3>
<ol>
  {% for r in rounds %}
    <li><a href="{{ url_for('view_round', tid=t.id, rid=r.id) }}">Round {{ r.number }}</a></li>
  {% endfor %}
</ol>
{% endblock %}
