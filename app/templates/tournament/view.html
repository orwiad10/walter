{% extends 'base.html' %}
{% block content %}
<h2>{{ t.name }}</h2>
<p>Format: {{ t.format }}{% if t.format == 'Draft' and t.is_cube %} (Cube){% endif %} | Cut: {{ t.cut|upper }}</p>
<p>Rules Enforcement Level: {{ t.rules_enforcement_level }}</p>
<p>Head Judge: {{ t.head_judge.name if t.head_judge else 'None' }}</p>
<p>Floor Judges:
  {% if floor_judges %}
    {% for u in floor_judges %}{{ u.name }}{% if not loop.last %}, {% endif %}{% endfor %}
  {% else %}None{% endif %}
</p>
{% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
<p><a class="btn" href="{{ url_for('assign_judges', tid=t.id) }}">Assign Judges</a></p>
{% endif %}
{% if show_passcode %}
<p>Tournament Passcode: {{ t.passcode }}</p>
{% endif %}
{% include 'tournament/_timer_bar.html' %}
{% set round_limit = t.rounds_override or rec_rounds %}
{% set current_rounds = rounds|length %}
<div class="toolbar">
  <button class="btn" onclick="window.print()">Print</button>
  {% if not is_player %}
  <div class="join-controls">
    {% if current_user.is_authenticated %}
      {% set join_pending = user_join_request and user_join_request.status == 'pending' %}
      {% set join_rejected = user_join_request and user_join_request.status == 'rejected' %}
      {% if t.join_requires_approval %}
        <div class="join-approval-note">Approval required before players may join this tournament.</div>
      {% endif %}
      {% if join_pending %}
        <div class="join-request-status info">Your join request is pending approval.</div>
      {% elif join_rejected %}
        <div class="join-request-status error">Your previous join request was rejected{% if user_join_request.note %}: {{ user_join_request.note }}{% endif %}.</div>
      {% endif %}
      {% set allow_join_form = (not t.join_requires_approval) or (not join_pending) %}
      {% if allow_join_form %}
      <form method="post" action="{{ url_for('join_tournament', tid=t.id) }}" class="join-form">
        <input type="text" name="passcode" maxlength="4" pattern="\d{4}" placeholder="Passcode" required>
        <button class="btn" type="submit">{% if t.join_requires_approval %}Request Join{% else %}Join{% endif %}</button>
      </form>
      {% endif %}
    {% else %}
      <a class="btn" href="{{ url_for('login') }}">Login to Join</a>
    {% endif %}
  </div>
  {% endif %}
  <a class="btn" href="{{ url_for('standings', tid=t.id) }}">Standings</a>
  {% if t.cut.startswith('top') %}
  <a class="btn" href="{{ url_for('bracket', tid=t.id) }}">Bracket</a>
  {% endif %}
  {% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
    {% if current_rounds < round_limit or t.cut.startswith('top') %}
    <form method="post" action="{{ url_for('pair_next_round', tid=t.id) }}">
      <button class="btn" type="submit">Pair</button>
    </form>
    {% endif %}
    <form method="post" action="{{ url_for('set_rounds', tid=t.id) }}">
      <input type="number" name="rounds" min="1" value="{{ t.rounds_override or rec_rounds }}">
      <button class="btn" type="submit">Set Rounds</button>
    </form>
    {% if t.format == 'Draft' %}
    <a class="btn" href="{{ url_for('draft_seating', tid=t.id) }}">Draft Seating</a>
    {% endif %}
  <a class="btn" href="{{ url_for('tournament_logs', tid=t.id) }}">Logs</a>
{% endif %}
</div>

{% if is_player %}
<section class="player-deck">
  <h3>Your Deck</h3>
  {% if player_deck %}
  <p class="deck-meta">
    Source: {{ player_deck.source|capitalize }}{% if player_deck.updated_at %} · Updated {{ player_deck.updated_at }}{% elif player_deck.created_at %} · Updated {{ player_deck.created_at }}{% endif %}
    {% if player_deck.moxfield_url %}· <a href="{{ player_deck.moxfield_url }}" target="_blank" rel="noopener">View on Moxfield</a>{% endif %}
    <span class="deck-status {% if player_deck.is_submitted %}deck-status-submitted{% else %}deck-status-draft{% endif %}">
      {% if player_deck.is_submitted %}
        Status: Submitted{% if player_deck.submitted_at %} · Submitted {{ player_deck.submitted_at }}{% endif %}
      {% else %}
        Status: Not submitted
      {% endif %}
    </span>
  </p>
  <div class="deck-lists">
    <div class="deck-list">
      <h4>Mainboard ({{ player_deck.total_mainboard() }})</h4>
      {% set main_cards = player_deck.mainboard_cards() %}
      {% if main_cards %}
      <ul>
        {% for card in main_cards %}
        <li>{{ card.count }} × {{ card.name }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No mainboard cards submitted.</p>
      {% endif %}
    </div>
    <div class="deck-list">
      <h4>Sideboard ({{ player_deck.total_sideboard() }})</h4>
      {% set side_cards = player_deck.sideboard_cards() %}
      {% if side_cards %}
      <ul>
        {% for card in side_cards %}
        <li>{{ card.count }} × {{ card.name }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No sideboard submitted.</p>
      {% endif %}
    </div>
  </div>
  {% if player_deck.image_path %}
  <div class="deck-image">
    <h4>Deck Image</h4>
    <img src="{{ url_for('media_file', filename=player_deck.image_path) }}" alt="Deck image" loading="lazy">
  </div>
  {% endif %}
  {% else %}
  <p>No deck information submitted yet.</p>
  <p class="deck-status deck-status-draft">Status: Not submitted</p>
  {% endif %}

  {% if deck_locked %}
  <p class="deck-locked-message">Deck changes are locked because round one has been paired.</p>
  {% else %}
  <div class="deck-forms">
    <form method="post" action="{{ url_for('upload_manual_deck', tid=t.id) }}" class="deck-form deck-builder-form" id="deck-builder-form" data-initial-deck='{{ deck_state|tojson }}' {% if deck_search_url %}data-search-url="{{ deck_search_url }}"{% endif %}>
      <input type="hidden" name="deck_json" id="deck-json-field">
      <div class="deck-builder">
        <div class="deck-builder-controls">
          {% if deck_search_url %}
          <label>Search card database
            <input type="text" id="card-search-input" placeholder="Card name" autocomplete="off">
          </label>
          <label>Quantity
            <input type="number" id="card-quantity-input" min="1" value="1">
          </label>
          <div class="deck-destination">
            <label><input type="radio" name="card-destination" value="main" checked> Mainboard</label>
            <label><input type="radio" name="card-destination" value="side"> Sideboard</label>
          </div>
          <div id="card-search-results" class="card-search-results" aria-live="polite"></div>
          {% endif %}
        </div>
        <div class="deck-builder-lists">
          <div class="deck-builder-list" data-board="main">
            <h4>Mainboard (<span data-board-count="main">0</span>)</h4>
            <ul class="deck-builder-entries" data-board-entries="main"></ul>
          </div>
          <div class="deck-builder-list" data-board="side">
            <h4>Sideboard (<span data-board-count="side">0</span>)</h4>
            <ul class="deck-builder-entries" data-board-entries="side"></ul>
          </div>
        </div>
      </div>
      <div class="deck-builder-actions">
        <button class="btn danger" type="button" id="deck-clear-button">Clear Deck</button>
        <button class="btn" type="submit" name="action" value="save">Save Deck</button>
        <button class="btn primary" type="submit" name="action" value="submit">Submit Deck</button>
      </div>
    </form>

    <form method="post" action="{{ url_for('upload_manual_deck', tid=t.id) }}" class="deck-form">
      <label>Paste deck list
        <textarea name="deck_text" rows="10" placeholder="4 Archon of Emeria
4 Chrome Mox
...
Sideboard
2 March of Otherworldly Light"></textarea>
      </label>
      <div class="deck-builder-actions">
        <button class="btn" type="submit" name="action" value="save">Save Deck</button>
        <button class="btn" type="submit" name="action" value="submit">Submit Deck</button>
      </div>
    </form>

    <form method="post" action="{{ url_for('import_moxfield_deck', tid=t.id) }}" class="deck-form">
      <label>Moxfield deck link or ID
        <input type="text" name="moxfield_url" placeholder="https://www.moxfield.com/decks/abcdef" required>
      </label>
      <button class="btn" type="submit">Import from Moxfield</button>
    </form>

    <form method="post" action="{{ url_for('upload_mtgo_deck', tid=t.id) }}" enctype="multipart/form-data" class="deck-form">
      <label>MTGO deck file (.txt)
        <input type="file" name="mtgo_file" accept=".txt" required>
      </label>
      <button class="btn" type="submit">Upload MTGO Deck</button>
    </form>

    {% if t.format == 'Draft' %}
    <form method="post" action="{{ url_for('upload_deck_image', tid=t.id) }}" enctype="multipart/form-data" class="deck-form">
      <label>Deck image (PNG/JPG)
        <input type="file" name="deck_image" accept="image/*" required>
      </label>
      <button class="btn" type="submit">Upload Deck Image</button>
    </form>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('deck-builder-form');
      if (!form) {
        return;
      }
      const searchUrl = form.dataset.searchUrl;
      let deckData;
      try {
        deckData = JSON.parse(form.dataset.initialDeck || '{}');
      } catch (err) {
        deckData = {};
      }
      const state = {
        main: Array.isArray(deckData.main) ? deckData.main.map(function(item){
          return {name: item.name, count: item.count};
        }) : [],
        side: Array.isArray(deckData.side) ? deckData.side.map(function(item){
          return {name: item.name, count: item.count};
        }) : [],
      };
      const hiddenField = document.getElementById('deck-json-field');
      const quantityInput = document.getElementById('card-quantity-input');
      const searchInput = document.getElementById('card-search-input');
      const results = document.getElementById('card-search-results');
      const destinationInputs = form.querySelectorAll('input[name="card-destination"]');
      const listContainers = {
        main: form.querySelector('[data-board-entries="main"]'),
        side: form.querySelector('[data-board-entries="side"]'),
      };
      const countDisplays = {
        main: form.querySelector('[data-board-count="main"]'),
        side: form.querySelector('[data-board-count="side"]'),
      };

      function currentDestination() {
        let value = 'main';
        destinationInputs.forEach(function(input){
          if (input.checked) {
            value = input.value;
          }
        });
        return value === 'side' ? 'side' : 'main';
      }

      function updateHiddenField() {
        hiddenField.value = JSON.stringify({
          main: state.main,
          side: state.side,
        });
      }

      function renderBoard(board) {
        const container = listContainers[board];
        if (!container) {
          return;
        }
        container.innerHTML = '';
        const cards = state[board];
        cards.forEach(function(card){
          const item = document.createElement('li');
          item.className = 'deck-builder-item';
          item.dataset.board = board;
          item.dataset.cardName = card.name;
          const count = document.createElement('span');
          count.className = 'deck-builder-count';
          count.textContent = card.count + '×';
          const name = document.createElement('span');
          name.className = 'deck-builder-name';
          name.textContent = card.name;
          const actions = document.createElement('div');
          actions.className = 'deck-builder-item-actions';
          [['+', 'increment'], ['−', 'decrement'], ['Remove', 'remove']].forEach(function(pair){
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn-small';
            button.dataset.action = pair[1];
            button.dataset.board = board;
            button.dataset.cardName = card.name;
            button.textContent = pair[0];
            if (pair[1] === 'remove') {
              button.classList.add('danger');
            }
            actions.appendChild(button);
          });
          item.appendChild(count);
          item.appendChild(name);
          item.appendChild(actions);
          container.appendChild(item);
        });
        const total = cards.reduce(function(sum, card){
          return sum + (card.count || 0);
        }, 0);
        if (countDisplays[board]) {
          countDisplays[board].textContent = total;
        }
      }

      function renderAll() {
        renderBoard('main');
        renderBoard('side');
        updateHiddenField();
      }

      function addCard(cardName, count, board) {
        if (!cardName || count <= 0) {
          return;
        }
        const cards = state[board];
        const existing = cards.find(function(card){ return card.name === cardName; });
        if (existing) {
          existing.count += count;
        } else {
          cards.push({name: cardName, count: count});
        }
        renderAll();
      }

      function modifyCard(board, cardName, delta) {
        const cards = state[board];
        for (let i = 0; i < cards.length; i++) {
          if (cards[i].name === cardName) {
            cards[i].count += delta;
            if (cards[i].count <= 0) {
              cards.splice(i, 1);
            }
            break;
          }
        }
        renderAll();
      }

      function removeCard(board, cardName) {
        const cards = state[board];
        const index = cards.findIndex(function(card){ return card.name === cardName; });
        if (index >= 0) {
          cards.splice(index, 1);
          renderAll();
        }
      }

      function clearDeck() {
        if (state.main.length === 0 && state.side.length === 0) {
          return;
        }
        state.main = [];
        state.side = [];
        renderAll();
      }

      form.addEventListener('click', function(event){
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const action = target.dataset.action;
        if (!action) {
          return;
        }
        const board = target.dataset.board;
        const cardName = target.dataset.cardName;
        if (!board || !cardName) {
          return;
        }
        if (action === 'increment') {
          modifyCard(board, cardName, 1);
        } else if (action === 'decrement') {
          modifyCard(board, cardName, -1);
        } else if (action === 'remove') {
          removeCard(board, cardName);
        }
      });

      const clearButton = document.getElementById('deck-clear-button');
      if (clearButton) {
        clearButton.addEventListener('click', function(){
          clearDeck();
        });
      }

      if (searchInput && results && searchUrl) {
        let timer = null;
        searchInput.addEventListener('input', function(){
          const query = searchInput.value.trim();
          if (timer) {
            clearTimeout(timer);
          }
          if (query.length < 2) {
            results.textContent = '';
            return;
          }
          timer = setTimeout(function(){
            fetch(searchUrl + '?q=' + encodeURIComponent(query))
              .then(function(resp){ return resp.json(); })
              .then(function(data){
                results.innerHTML = '';
                if (!data || !Array.isArray(data.results) || data.results.length === 0) {
                  results.textContent = 'No results';
                  return;
                }
                const list = document.createElement('ul');
                data.results.forEach(function(name){
                  const item = document.createElement('li');
                  item.textContent = name;
                  item.addEventListener('click', function(){
                    let qty = parseInt(quantityInput.value, 10);
                    if (Number.isNaN(qty) || qty <= 0) {
                      qty = 1;
                    }
                    addCard(name, qty, currentDestination());
                  });
                  list.appendChild(item);
                });
                results.appendChild(list);
              })
              .catch(function(){
                results.textContent = 'Search failed';
              });
          }, 250);
        });
      }

      form.addEventListener('submit', function(){
        updateHiddenField();
      });

      renderAll();
    });
  </script>
  {% endif %}
</section>
{% endif %}

{% if current_user.is_authenticated and current_user.has_permission('tournaments.approve_join') and t.join_requires_approval %}
<section class="join-requests">
  <h3>Join Requests</h3>
  {% if pending_join_requests %}
  <table class="table">
    <tr><th>Player</th><th>Requested</th><th>Existing Note</th></tr>
    {% for req in pending_join_requests %}
    <tr>
      <td>{{ req.user.name if req.user else 'Unknown' }}</td>
      <td>{{ req.created_at }}</td>
      <td>{{ req.note or '-' }}</td>
    </tr>
    <tr>
      <td colspan="3">
        <form method="post" action="{{ url_for('approve_join_request', tid=t.id, req_id=req.id) }}" class="join-request-form">
          <label>Note
            <textarea name="note" rows="2">{{ req.note or '' }}</textarea>
          </label>
          <div class="join-request-actions">
            <button class="btn" type="submit">Approve</button>
            <button class="btn" type="submit" formaction="{{ url_for('reject_join_request', tid=t.id, req_id=req.id) }}">Reject</button>
          </div>
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
  {% else %}
  <p>No pending join requests.</p>
  {% endif %}
</section>
{% endif %}

{% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
<section class="inline-add-player">
  <h3>Add Player</h3>
  <form method="post" action="{{ url_for('add_player_to_tournament', tid=t.id) }}" class="message-form add-player-form">
    <label>Find Existing Player
      <input type="text" id="add-player-search" placeholder="Search by name or email" autocomplete="off">
    </label>
    <div id="add-player-results" class="user-lookup-results" aria-live="polite"></div>
    <input type="hidden" name="user_id" id="add-player-id">
    <p class="inline-form-divider">or quick add</p>
    <label>Player Name
      <input type="text" name="new_player_name" placeholder="New player name">
    </label>
    <label>Email (optional)
      <input type="email" name="new_player_email" placeholder="email@example.com">
    </label>
    <button class="btn" type="submit">Add Player</button>
  </form>
</section>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    if(window.attachUserLookup){
      window.attachUserLookup('add-player-search', 'add-player-results', 'add-player-id');
    }
  });
</script>
{% endif %}

<h3>Players ({{ players|length }})</h3>
<table class="players-table">
  <tbody>
  {% for p in players %}
    <tr><td>{{ p.user.name }}</td></tr>
  {% endfor %}
  </tbody>
</table>

<h3>Rounds</h3>
<ol>
  {% for r in rounds %}
    <li><a href="{{ url_for('view_round', tid=t.id, rid=r.id) }}">Round {{ r.number }}</a></li>
  {% endfor %}
</ol>
{% endblock %}
