{% extends 'base.html' %}
{% block content %}
<p><a href="{{ url_for('view_tournament', tid=t.id) }}">Back to Tournament</a></p>
<h2>{{ t.name }} â€” Round {{ r.number }}</h2>
{% include 'tournament/_timer_bar.html' %}
{% if current_user.is_authenticated and current_user.has_permission('tournaments.manage') %}
<form method="post" action="{{ url_for('repair_round', tid=t.id, rid=r.id) }}" style="display:inline;">
  <button class="btn" type="submit">Re-pair</button>
</form>
{% if not has_results %}
<form method="post" action="{{ url_for('delete_round', tid=t.id, rid=r.id) }}" style="display:inline;" onsubmit="return confirm('Delete this round?');">
  <button class="btn" type="submit">Delete Round</button>
</form>
{% endif %}
{% endif %}
<table class="table">
  <thead>
    <tr>
      <th>Table</th>
      <th>Players</th>
      <th>Result</th>
    </tr>
  </thead>
  <tbody>
  {% for m in r.matches|sort(attribute='table_number') %}
    <tr>
      <td>{{ m.table_number }}</td>
      <td>
        {% if t.format == 'Commander' %}
          {{ m.player1.user.name }}{% if m.player2_id %}, {{ m.player2.user.name }}{% endif %}{% if m.player3_id %}, {{ m.player3.user.name }}{% endif %}{% if m.player4_id %}, {{ m.player4.user.name }}{% endif %}
        {% else %}
          {% if m.player2_id %}
            {{ m.player1.user.name }} vs {{ m.player2.user.name }}
          {% else %}
            {{ m.player1.user.name }} has a BYE
          {% endif %}
        {% endif %}
      </td>
      <td>
        {% if t.format == 'Commander' %}
          {% if m.completed %}
            {% if m.result.is_draw %}Draw{% else %}Placings: {{ m.result.p1_place }}{% if m.player2_id %}, {{ m.result.p2_place }}{% endif %}{% if m.player3_id %}, {{ m.result.p3_place }}{% endif %}{% if m.player4_id %}, {{ m.result.p4_place }}{% endif %}{% endif %}
            {% if not locked %}
              {% set ids = [m.player1.user_id, m.player2.user_id if m.player2_id else None, m.player3.user_id if m.player3_id else None, m.player4.user_id if m.player4_id else None] %}
              {% if current_user.is_authenticated and (current_user.has_permission('tournaments.manage') or current_user.id in ids) %}
                <a href="{{ url_for('report_match', mid=m.id) }}">Edit</a>
              {% endif %}
            {% endif %}
          {% else %}
            {% if not locked %}
              {% set ids = [m.player1.user_id, m.player2.user_id if m.player2_id else None, m.player3.user_id if m.player3_id else None, m.player4.user_id if m.player4_id else None] %}
              {% if current_user.is_authenticated and (current_user.has_permission('tournaments.manage') or current_user.id in ids) %}
                <a href="{{ url_for('report_match', mid=m.id) }}">Report</a>
              {% endif %}
            {% endif %}
          {% endif %}
        {% else %}
          {% if m.completed %}
            {% if m.player2_id %}
              {{ m.result.player1_wins }}-{{ m.result.player2_wins }} (Draws {{ m.result.draws }})
            {% else %}
              Win by BYE
            {% endif %}
            {% if not locked %}
              {% if current_user.is_authenticated and (current_user.has_permission('tournaments.manage') or current_user.id in (m.player1.user_id, m.player2.user_id or -1)) %}
                <a href="{{ url_for('report_match', mid=m.id) }}">Edit</a>
              {% endif %}
            {% endif %}
          {% else %}
            {% if not locked and current_user.is_authenticated and (current_user.has_permission('tournaments.manage') or current_user.id in (m.player1.user_id, m.player2.user_id or -1)) %}
              <a href="{{ url_for('report_match', mid=m.id) }}">Report</a>
            {% endif %}
          {% endif %}
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
