{% extends 'base.html' %}
{% block content %}
<h2>Edit Tournament</h2>
<form method="post">
  <table class="table center-table">
    <tbody>
      <tr>
        <td>Name</td>
        <td><input name="name" value="{{ t.name }}" required></td>
      </tr>
      <tr>
        <td>Format</td>
        <td>
          <select name="format" id="tournament-format" required>
            <option{% if t.format=='Commander' %} selected{% endif %}>Commander</option>
            <option{% if t.format=='Draft' %} selected{% endif %}>Draft</option>
            <option{% if t.format=='Constructed' %} selected{% endif %}>Constructed</option>
          </select>
        </td>
      </tr>
      <tr class="cube-row">
        <td>Cube Draft</td>
        <td>
          <label><input type="checkbox" name="is_cube" value="1"{% if t.is_cube %} checked{% endif %}> Mark this draft as a cube event</label>
        </td>
      </tr>
      {% set form_structure = request.form.get('structure') %}
      {% if not form_structure %}
        {% if (t.pairing_type or 'swiss').lower() == 'round_robin' %}
          {% set form_structure = 'round_robin' %}
        {% else %}
          {% set form_structure = t.structure %}
        {% endif %}
      {% endif %}
      <tr>
        <td>Structure</td>
        <td>
          <select name="structure" id="tournament-structure">
            <option value="swiss"{% if form_structure == 'swiss' %} selected{% endif %}>Swiss / Cut</option>
            <option value="round_robin"{% if form_structure == 'round_robin' %} selected{% endif %}>Round Robin</option>
            <option value="single_elim"{% if form_structure == 'single_elim' %} selected{% endif %}>Single Elimination</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>Rules Enforcement Level</td>
        <td>
          <select name="rules_enforcement_level">
            {% for option in ['None','Casual','Competitive','Professional'] %}
            <option value="{{ option }}"{% if t.rules_enforcement_level == option %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
      <tr class="cut-row">
        <td>Cut</td>
        <td>
          <select name="cut">
            <option value="none"{% if t.cut=='none' %} selected{% endif %}>None</option>
            <option value="top64"{% if t.cut=='top64' %} selected{% endif %}>Top 64</option>
            <option value="top32"{% if t.cut=='top32' %} selected{% endif %}>Top 32</option>
            <option value="top16"{% if t.cut=='top16' %} selected{% endif %}>Top 16</option>
            <option value="top8"{% if t.cut=='top8' %} selected{% endif %}>Top 8</option>
            <option value="top4"{% if t.cut=='top4' %} selected{% endif %}>Top 4</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>Commander Points (1st,2nd,3rd,4th,draw)</td>
        <td><input name="commander_points" value="{{ t.commander_points }}"></td>
      </tr>
      <tr>
        <td>Round Length (minutes)</td>
        <td><input type="number" name="round_length" value="{{ t.round_length }}"></td>
      </tr>
      <tr>
        <td>Draft Time (minutes)</td>
        <td><input type="number" name="draft_time" value="{{ t.draft_time or '' }}"></td>
      </tr>
      <tr>
        <td>Deck Build Time (minutes)</td>
        <td><input type="number" name="deck_build_time" value="{{ t.deck_build_time or '' }}"></td>
      </tr>
      <tr>
        <td>Starting Table Number</td>
        <td><input type="number" name="start_table_number" min="1" value="{{ request.form.get('start_table_number', t.start_table_number or 1) }}"></td>
      </tr>
      <tr>
        <td>Start Time</td>
        <td><input type="datetime-local" name="start_time" value="{{ t.start_time.strftime('%Y-%m-%dT%H:%M') if t.start_time else '' }}"></td>
      </tr>
      <tr>
        <td>Require Join Approval</td>
        <td>
          <label><input type="checkbox" name="join_requires_approval" value="1"{% if t.join_requires_approval %} checked{% endif %}> Require staff approval before players join</label>
        </td>
      </tr>
      <tr>
        <td colspan="2"><button class="btn" type="submit">Save</button></td>
      </tr>
    </tbody>
  </table>
</form>
<script>
const fmtSel = document.querySelector('#tournament-format');
const structureSel = document.querySelector('#tournament-structure');
const cutSel = document.querySelector('select[name="cut"]');
const cutRow = document.querySelector('.cut-row');
const cubeRow = document.querySelector('.cube-row');

function updateCutOptions(){
  if(!cutSel){ return; }
  const top8 = cutSel.querySelector('option[value="top8"]');
  if(top8){
    if(fmtSel.value === 'Commander'){
      top8.style.display = 'none';
      if(cutSel.value === 'top8'){ cutSel.value = 'top4'; }
    }else{
      top8.style.display = '';
    }
  }
  if(cubeRow){
    cubeRow.style.display = fmtSel.value === 'Draft' ? '' : 'none';
  }
}

function updateStructure(){
  if(!cutSel || !cutRow){ return; }
  const structure = structureSel ? structureSel.value : 'swiss';
  if(structure === 'swiss'){
    cutRow.style.display = '';
  }else{
    cutRow.style.display = 'none';
    cutSel.value = 'none';
  }
}

fmtSel.addEventListener('change', () => {
  updateCutOptions();
  updateStructure();
});
if(structureSel){
  structureSel.addEventListener('change', () => {
    updateStructure();
  });
}
updateCutOptions();
updateStructure();
</script>
{% endblock %}
