<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or 'WaLTER' }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <div class="brand-group">
        <h1 class="brand"><a href="{{ url_for('index') }}">WaLTER</a></h1>
        {% if current_user.is_authenticated %}
        <span class="nav-chip">Hi, {{ current_user.name }}</span>
        {% endif %}
      </div>
      <button class="menu-toggle" type="button" aria-label="Toggle navigation" aria-controls="main-nav" aria-expanded="false">
        <span class="menu-toggle__icon" aria-hidden="true"></span>
        Menu
      </button>
      <nav class="app-nav" id="main-nav">
        <ul class="nav-list">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">All Tournaments</a></li>
          {% if current_user.is_authenticated %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('messages_home') }}">Messages <span id="nav-messages-count" class="nav-badge{% if not nav_unread_messages %} hidden{% endif %}">{{ nav_unread_messages }}</span></a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('lost_and_found') }}">Lost &amp; Found</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('submit_report') }}">Report Issue</a></li>
          {% if current_user.has_permission('tournaments.manage') %}
          <li class="nav-item has-dropdown">
            <button class="nav-link" type="button" data-dropdown-toggle aria-expanded="false">Tournament Tools</button>
            <div class="dropdown-menu" role="menu">
              <a class="dropdown-item" href="{{ url_for('new_tournament') }}">New Tournament</a>
              <a class="dropdown-item" href="{{ url_for('admin_register_player') }}">Register Player</a>
              <a class="dropdown-item" href="{{ url_for('admin_bulk_register') }}">Bulk Register Players</a>
              <a class="dropdown-item" href="{{ url_for('staff_management') }}">Staff</a>
              <a class="dropdown-item" href="{{ url_for('schedule') }}">Schedule</a>
            </div>
          </li>
          {% endif %}
          {% if current_user.has_permission('users.manage') or current_user.has_permission('admin.panel') or current_user.has_permission('admin.permissions') %}
          <li class="nav-item has-dropdown">
            <button class="nav-link" type="button" data-dropdown-toggle aria-expanded="false">Admin</button>
            <div class="dropdown-menu" role="menu">
              {% if current_user.has_permission('users.manage') %}
              <a class="dropdown-item" href="{{ url_for('admin_users') }}">Manage Users</a>
              {% endif %}
              {% if current_user.has_permission('admin.panel') %}
              <a class="dropdown-item" href="{{ url_for('admin_panel') }}">Admin Panel</a>
              <a class="dropdown-item" href="{{ url_for('site_logs') }}">Site Logs</a>
              <a class="dropdown-item" href="{{ url_for('admin_reports') }}">Reports <span id="nav-reports-count" class="nav-badge{% if not nav_open_reports %} hidden{% endif %}">{{ nav_open_reports }}</span></a>
              {% endif %}
              {% if current_user.has_permission('admin.permissions') %}
              <a class="dropdown-item" href="{{ url_for('permissions') }}">Permissions</a>
              {% endif %}
            </div>
          </li>
          {% endif %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
          {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}">Register</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </header>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flashes">
        {% for cat, msg in messages %}
          <li class="{{ cat }}">{{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
  <main class="app-main">
    <div class="content-wrapper">
      {% block content %}{% endblock %}
    </div>
  </main>
  <script>
  function formatTime(seconds){
    const m = Math.floor(seconds/60);
    const s = seconds%60;
    return m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
  }
  const typeLabels = {round:'round', draft:'draft', deck:'deck building', break:'break'};
  document.querySelectorAll('.timer').forEach(function(el){
    let remaining = null;
    let countdown = true;
    if(el.dataset.timerEnd){
      const end = new Date(el.dataset.timerEnd);
      if(el.dataset.serverNow){
        const serverNow = new Date(el.dataset.serverNow);
        remaining = Math.floor((end - serverNow)/1000);
      }else{
        remaining = Math.floor((end - new Date())/1000);
      }
    }else if(el.dataset.timerRemaining){
      remaining = parseInt(el.dataset.timerRemaining);
      countdown = false;
    }
    function tick(){
      if(remaining === null){
        el.textContent = '00:00';
        return;
      }
      if(remaining <= 0){
        el.textContent = '00:00';
        const key = 'alerted_' + (el.dataset.tournamentId||'') + '_' + (el.dataset.timerType||'') + '_' + (el.dataset.timerEnd||'');
        if(!localStorage.getItem(key)){
          const label = typeLabels[el.dataset.timerType] || '';
          alert('Time has elapsed for ' + (el.dataset.tournamentName||'') + ' ' + label + ' timer');
          localStorage.setItem(key, '1');
        }
      }else{
        el.textContent = formatTime(remaining);
        remaining -= 1;
        setTimeout(tick,1000);
      }
    }
    if(countdown){
      tick();
    }else if(remaining !== null){
      el.textContent = formatTime(remaining);
    }else{
      el.textContent = '00:00';
    }
  });
  const menuToggle = document.querySelector('.menu-toggle');
  const nav = document.querySelector('.app-nav');
  if(menuToggle && nav){
    menuToggle.addEventListener('click', function(){
      const isOpen = nav.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      if(!isOpen){
        closeDropdowns();
      }
    });
  }
  const dropdownButtons = Array.prototype.slice.call(document.querySelectorAll('[data-dropdown-toggle]'));
  function closeDropdowns(){
    dropdownButtons.forEach(function(btn){
      const parent = btn.closest('.has-dropdown');
      const menu = btn.nextElementSibling;
      if(parent){
        parent.classList.remove('open');
      }
      if(menu){
        menu.classList.remove('open');
      }
      btn.setAttribute('aria-expanded', 'false');
    });
  }
  dropdownButtons.forEach(function(btn){
    const parent = btn.closest('.has-dropdown');
    const menu = btn.nextElementSibling;
    if(!menu){
      return;
    }
    btn.addEventListener('click', function(ev){
      ev.stopPropagation();
      const isOpen = menu.classList.contains('open');
      closeDropdowns();
      if(!isOpen){
        if(parent){
          parent.classList.add('open');
        }
        menu.classList.add('open');
        btn.setAttribute('aria-expanded', 'true');
      }
    });
  });
  document.addEventListener('click', function(){
    closeDropdowns();
  });
  document.addEventListener('keydown', function(ev){
    if(ev.key === 'Escape'){
      closeDropdowns();
    }
  });
  const userSearchEndpoint = "{{ url_for('api_user_search') }}";
  function attachUserLookup(searchInputId, resultsContainerId, hiddenInputId, emailInputId){
    const searchInput = document.getElementById(searchInputId);
    const resultsContainer = document.getElementById(resultsContainerId);
    if(!searchInput || !resultsContainer){
      return;
    }
    const hiddenInput = hiddenInputId ? document.getElementById(hiddenInputId) : null;
    const emailInput = emailInputId ? document.getElementById(emailInputId) : null;
    searchInput.addEventListener('input', function(){
      const query = searchInput.value.trim();
      if(query.length < 2){
        resultsContainer.innerHTML = '';
        resultsContainer.classList.remove('open');
        if(hiddenInput){
          hiddenInput.value = '';
        }
        return;
      }
      fetch(userSearchEndpoint + '?q=' + encodeURIComponent(query))
        .then(function(resp){
          if(!resp.ok){
            throw new Error('search failed');
          }
          return resp.json();
        })
        .then(function(data){
          resultsContainer.innerHTML = '';
          const results = data.results || [];
          if(!results.length){
            const empty = document.createElement('div');
            empty.className = 'user-lookup-empty';
            empty.textContent = 'No matching users';
            resultsContainer.appendChild(empty);
            resultsContainer.classList.add('open');
            return;
          }
          results.forEach(function(user){
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'user-lookup-option';
            option.textContent = user.name + (user.email ? ' (' + user.email + ')' : '');
            option.addEventListener('click', function(){
              searchInput.value = user.name;
              if(hiddenInput){
                hiddenInput.value = user.id;
              }
              if(emailInput && user.email){
                emailInput.value = user.email;
              }
              resultsContainer.innerHTML = '';
              resultsContainer.classList.remove('open');
            });
            resultsContainer.appendChild(option);
          });
          resultsContainer.classList.add('open');
        })
        .catch(function(){
          resultsContainer.innerHTML = '';
          resultsContainer.classList.remove('open');
        });
    });
  }
  window.attachUserLookup = attachUserLookup;
  {% if current_user.is_authenticated %}
  (function(){
    if(!window.sessionStorage){
      return;
    }
    fetch("{{ url_for('api_unread_messages') }}")
      .then(function(resp){
        if(!resp.ok){
          throw new Error('unread failed');
        }
        return resp.json();
      })
      .then(function(data){
        if(!data || typeof data.count !== 'number'){
          return;
        }
        const navBadge = document.getElementById('nav-messages-count');
        if(navBadge){
          if(data.count > 0){
            navBadge.textContent = data.count;
            navBadge.classList.remove('hidden');
          }else{
            navBadge.textContent = '';
            navBadge.classList.add('hidden');
          }
        }
        const key = 'walter_unread_count';
        if(data.count > 0){
          const previous = sessionStorage.getItem(key);
          if(previous !== String(data.count)){
            alert('You have ' + data.count + ' unread message' + (data.count === 1 ? '' : 's') + '.');
            sessionStorage.setItem(key, String(data.count));
          }
        }else{
          sessionStorage.removeItem(key);
        }
      })
      .catch(function(){
        /* ignore errors */
      });
  })();
  {% endif %}
  </script>
</body>
</html>
