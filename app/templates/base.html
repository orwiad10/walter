<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or 'WaLTER' }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1><a href="{{ url_for('index') }}">WaLTER</a></h1>
    <button class="menu-toggle" aria-label="Toggle navigation">Menu</button>
    <nav>
      {% if current_user.is_authenticated %}
        <span>Hi, {{ current_user.name }}</span>
        <a href="{{ url_for('index') }}">All Tournaments</a>
        <a href="{{ url_for('messages_inbox') }}">Messages</a>
        {% if current_user.has_permission('tournaments.manage') %}
        <a href="{{ url_for('new_tournament') }}">New Tournament</a>
        <a href="{{ url_for('admin_register_player') }}">Register Player</a>
        <a href="{{ url_for('admin_bulk_register') }}">Bulk Register Players</a>
        <a href="{{ url_for('staff_management') }}">Staff</a>
        <a href="{{ url_for('schedule') }}">Schedule</a>
        {% endif %}
        {% if current_user.has_permission('users.manage') %}
        <a href="{{ url_for('admin_users') }}">Manage Users</a>
        {% endif %}
        {% if current_user.has_permission('admin.panel') %}
        <a href="{{ url_for('admin_panel') }}">Admin Panel</a>
        <a href="{{ url_for('site_logs') }}">Site Logs</a>
        {% endif %}
        {% if current_user.has_permission('admin.permissions') %}
        <a href="{{ url_for('permissions') }}">Permissions</a>
        {% endif %}
        <a href="{{ url_for('logout') }}">Logout</a>
      {% else %}
        <a href="{{ url_for('index') }}">All Tournaments</a>
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
      {% endif %}
    </nav>
  </header>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flashes">
        {% for cat, msg in messages %}
          <li class="{{ cat }}">{{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
  <main>
    {% block content %}{% endblock %}
  </main>
  <script>
  function formatTime(seconds){
    const m = Math.floor(seconds/60);
    const s = seconds%60;
    return m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
  }
  const typeLabels = {round:'round', draft:'draft', deck:'deck building', break:'break'};
  document.querySelectorAll('.timer').forEach(function(el){
    let remaining = null;
    let countdown = true;
    if(el.dataset.timerEnd){
      const end = new Date(el.dataset.timerEnd);
      if(el.dataset.serverNow){
        const serverNow = new Date(el.dataset.serverNow);
        remaining = Math.floor((end - serverNow)/1000);
      }else{
        remaining = Math.floor((end - new Date())/1000);
      }
    }else if(el.dataset.timerRemaining){
      remaining = parseInt(el.dataset.timerRemaining);
      countdown = false;
    }
    function tick(){
      if(remaining === null){
        el.textContent = '00:00';
        return;
      }
      if(remaining <= 0){
        el.textContent = '00:00';
        const key = 'alerted_' + (el.dataset.tournamentId||'') + '_' + (el.dataset.timerType||'') + '_' + (el.dataset.timerEnd||'');
        if(!localStorage.getItem(key)){
          const label = typeLabels[el.dataset.timerType] || '';
          alert('Time has elapsed for ' + (el.dataset.tournamentName||'') + ' ' + label + ' timer');
          localStorage.setItem(key, '1');
        }
      }else{
        el.textContent = formatTime(remaining);
        remaining -= 1;
        setTimeout(tick,1000);
      }
    }
    if(countdown){
      tick();
    }else if(remaining !== null){
      el.textContent = formatTime(remaining);
    }else{
      el.textContent = '00:00';
    }
  });
  const menuToggle = document.querySelector('.menu-toggle');
  const nav = document.querySelector('header nav');
  if(menuToggle && nav){
    menuToggle.addEventListener('click', function(){
      nav.classList.toggle('open');
    });
  }
  </script>
</body>
</html>
